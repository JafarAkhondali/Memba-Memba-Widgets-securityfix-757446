<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>widgets.navigation</title>
    <script>
        window.DEBUG = true;
    </script>
    <!-- Kidoju fonts -->
    <link href="../../styles/fonts/kidoju.css" rel="stylesheet">
    <!-- Kidoju theme -->
    <link href="../../styles/themes/app.theme.nordic.css" rel="stylesheet">
    <!-- SystemJS loader -->
    <script src="../../../test/vendor/polyfill.min.js"></script>
    <script src="../../../test/vendor/system.js"></script>
    <script src="../../js/helpers/system.config.js"></script>
    <script>
        (function () {
            'use strict';
            Promise.all([
                SystemJS.import('kendo.binder'),
                SystemJS.import('kendo.splitter'),
                SystemJS.import('../cultures/all.en.es6'),
                SystemJS.import('../helpers/helpers.data.es6'),
                SystemJS.import('../data/data.page.es6'),
                SystemJS.import('../tools/tools.es6'),
                SystemJS.import('./widgets.navigation.es6')
            ]).then(function (modules) {
                var kendo = window.kendo;
                var data = modules[3].getPageArray();
                var Page = modules[4].Page;
                var PageDataSource = modules[4].PageDataSource;
                var tools = modules[5].default;
                var promises = Object.keys(modules[3].componentGenerator).map(function (tool) {
                    // Load tool
                    return tools.load(tool);
                });
                $.when.apply($, promises).then(() => {
                    var pageDataSource = new PageDataSource({data});
                    var viewModel = window.viewModel = kendo.observable({
                        current: undefined,
                        pages: pageDataSource
                    });
                    var onResize = window.onResize = function() {
                        var navigationWidget = $('[data-role="navigation"]').data('kendoNavigation'),
                            stage = $('#right [data-role="stage"]'),
                            stageWidget = stage.data('kendoStage');
                        if (navigationWidget instanceof kendo.ui.Navigation) {
                            navigationWidget.resize();
                        }
                        if (stageWidget instanceof kendo.ui.Stage) {
                            var width = $('#right').width();
                            var height = $('#right').height();
                            var scale = Math.min(0.90 * width / 1024, 0.90 * height / 768);
                            stageWidget.scale(scale);
                            $('.centered').
                                width(scale * stage.outerWidth()).
                                height(scale * stage.outerHeight()).
                                css('position', 'absolute').
                                css('top', '50%').
                                css('left', '50%').
                                css('margin-left', '-' + scale * stage.outerWidth() / 2 + 'px').
                                css('margin-top', '-' + scale * stage.outerHeight() / 2 + 'px');
                        }
                    };

                    $(function() {
                        var splitter = $('.kj-splitter').kendoSplitter({
                            orientation: 'horizontal',
                            resize: window.onResize,
                            panes: [
                                {size: '300px' /*, min: '50px', max: '500px'*/},
                                {}
                            ]
                        }).data("kendoSplitter");

                        $(window).on('resize', window.onResize);
                        $(document).on('keypress', function(e) {
                            //Add empty pages when pressing the space bar
                            if (e.type === 'keypress' && e.keyCode === 32) {
                                var page = new Page();
                                viewModel.pages.add(page);
                            }
                        });

                        pageDataSource.fetch().then(function() {
                            promises = [];
                            pageDataSource.data().forEach(page => {
                                promises.push(page.components.fetch());
                                $.when(promises).then(() => {
                                    window.viewModel.set('current', pageDataSource.at(0));
                                    kendo.bind('body', viewModel);
                                    window.onResize();
                                });
                            });
                        });
                    });
                });
            });
        }());
    </script>
    <style>
        html {
            /* See: http://www.telerik.com/forums/100-window-height-splitter */
            overflow: hidden;
        }

        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
        }

        .kj-splitter {
            height: 100%;
            border: 0;
        }

        #left,
        [data-role="navigation"] {
            height: 100%;
            border: 0;
        }
    </style>
</head>
<body>
<div class="kj-splitter">
    <div id="left">
        <div data-role="navigation" data-bind="source: pages, value: current"></div>
    </div>
    <div id="right">
        <div class="centered">
            <div data-role="stage" data-bind="source: current.components"></div>
        </div>
    </div>
</div>
</body>
</html>
