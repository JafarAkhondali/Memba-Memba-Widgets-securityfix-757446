<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>widgets.stage</title>
    <script>
        window.DEBUG = true;
    </script>
    <!-- Memba fonts -->
    <link href="../../styles/fonts/memba.css" rel="stylesheet">
    <!-- Application theme -->
    <link href="../../styles/themes/app.theme.nordic.css" rel="stylesheet">
    <!-- SystemJS loader -->
    <script src="../../../test/vendor/polyfill.min.js"></script>
    <script src="../../../test/vendor/system.js"></script>
    <script src="../../js/helpers/system.config.js"></script>
    <script>
        (function () {
            'use strict';
            Promise.all([
                SystemJS.import('kendo.binder'),
                SystemJS.import('kendo.slider'),
                SystemJS.import('../cultures/all.en.es6'),
                SystemJS.import('../data/data.pagecomponent.es6'),
                SystemJS.import('../helpers/helpers.data.es6'),
                SystemJS.import('../helpers/helpers.grid.es6'),
                SystemJS.import('../tools/tools.es6'),
                SystemJS.import('./widgets.toolbox.es6'),
                SystemJS.import('./widgets.stage.es6'),
            ]).then(function (modules) {
                var kendo = window.kendo;
                var PageComponentDataSource = modules[3].PageComponentDataSource;
                var data = modules[4].getComponentArray();
                var tools = modules[6].default;
                var promises = data.map(function (component) {
                    // Load tool
                    return tools.load(component.tool);
                });
                $.when.apply($, promises).then(() => {
                    var viewModel = kendo.observable({
                        components: new PageComponentDataSource({data}),
                        component: null,
                        onSliderChange(e) {
                            var stage = $('#stage').data('kendoStage');
                            stage.scale(e.value / 100);
                        },
                        onInputModeChange(e) {
                            var stage = $('#stage').data('kendoStage');
                            var m = e.currentTarget.value;
                            window.location.hash = m;
                            stage.mode(m);
                        },
                        onEnabledChange(e) {
                            var stage = $('#stage').data('kendoStage');
                            switch (e.currentTarget.id) {
                                case "enabled":
                                    stage.enable(e.currentTarget.checked);
                                    break;
                                case "readonly":
                                    stage.readonly(e.currentTarget.checked);
                                    break;
                            }
                        },
                        onGridSelect(e) {
                            var stage = $('#stage').data('kendoStage');
                            var rows = this.select();
                            var component = this.dataItem(rows[0]);
                            if (component) {
                                stage.value(component);
                            }
                        },
                        onStageSelect(e) {
                            var grid = $('#grid').data('kendoGrid');
                            if (e.value) {
                                var uid = grid.dataSource.get(e.value.id).uid;
                                var rows = grid.table.find('tr[data-uid="' + uid + '"]');
                                if (!rows.hasClass('k-state-selected')) {
                                    grid.select(rows);
                                }
                            } else {
                                grid.clearSelection();
                            }
                        }
                    });
                    $(function() {
                        var mode = window.location.hash.substr(1);
                        mode = mode.length ? mode : 'design';

                        // Prepare slider for binding
                        $('#slider').
                            attr(kendo.attr('role'), 'slider').
                            attr(kendo.attr('decreaseButtonTitle'), 'Zoom out').
                            attr(kendo.attr('increaseButtonTitle'), 'Zoom in').
                            attr(kendo.attr('largeStep'), 10).
                            attr(kendo.attr('min'), 0).
                            attr(kendo.attr('max'), 100).
                            attr(kendo.attr('smallStep'), 1);

                        $('input#' + mode).prop('checked', true);

                        $('input[type="radio"][name="mode"]').
                            attr(kendo.attr('bind'), 'events: { change: onInputModeChange }');

                        $('input[type="checkbox"]').attr(kendo.attr('bind'), 'events: { change: onEnabledChange }');

                        // Prepare toolbox
                        $('#toolbox').attr(kendo.attr('role'), 'toolbox');

                        // Prepare stage for binding
                        // TODO $('#stage, #stage2')
                        $('#stage').
                            attr(kendo.attr('role'), 'stage').
                            attr(kendo.attr('autoBind'), false).
                            attr(kendo.attr('bind'), 'source: components, value: component').
                            attr(kendo.attr('mode'), mode);

                        // Prepare grid for binding
                        $('#grid').
                            attr(kendo.attr('role'), 'grid').
                            attr(kendo.attr('autoBind'), false).
                            attr(kendo.attr('bind'), 'source: components').
                            attr(kendo.attr('editable'), true).
                            attr(kendo.attr('height'), 300).
                            attr(kendo.attr('selectable'), true).
                            attr(kendo.attr('columns'), JSON.stringify([
                                {
                                    field: "id",
                                    title: "Id",
                                    width: 320
                                },
                                {
                                    field: "tool",
                                    title: "Tool",
                                    width: 100
                                },
                                {
                                    field: "top",
                                    title: "Top",
                                    width: 60
                                },
                                {
                                    field: "left",
                                    title: "Left",
                                    width: 60
                                },
                                {
                                    field: "height",
                                    title: "Hei.",
                                    width: 60
                                },
                                {
                                    field: "width",
                                    title: "Wid.",
                                    width: 60
                                },
                                {
                                    field: "rotate",
                                    title: "Rot.",
                                    width: 60
                                },
                                /*
                            {
                                field: "attributes",
                                title: "Attributes"
                            },
                            {
                                field: "properties",
                                title: "Properties"
                            },
                            */
                                {
                                    command: "destroy",
                                    title: "&nbsp;",
                                    width: 120
                                }
                            ])).
                            attr(kendo.attr('height'), 300);

                        // Bind html and events
                        kendo.bind('body', viewModel);
                        $('#slider').data('kendoSlider').bind('change', viewModel.onSliderChange);
                        $('#stage').data('kendoStage').bind('select', viewModel.onStageSelect);
                        $('#grid').data('kendoGrid').bind('change', viewModel.onGridSelect);

                        //Note: we have autoBind = false, so we need to read manually
                        viewModel.components.read();

                    });
                });
            });
        }());
    </script>
    <style>
        body { background-color: darkgrey; }
    </style>
</head>
<body>
<h1>widgets.stage</h1>
<div>
    <input id="slider" value="100" />
    <input id="design" type="radio" name="mode" value="design" checked=true /><label for="design">design</label>
    <input id="play" type="radio" name="mode" value="play" /><label for="play">play</label>
    <input id="review" type="radio" name="mode" value="review" /><label for="review">review</label>
    <input id="enabled" type="checkbox" checked /><label for="enabled">enabled</label>
    <input id="readonly" type="checkbox" /><label for="readonly">readonly</label>
</div>
<div id="toolbox"></div>
<div id="stage"></div>
<div id="grid"></div>
<div id="stage2" data-scale="0.25"></div>
</body>
</html>
