<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>widgets.stage</title>
    <script>
        window.app = { DEBUG: true };
    </script>
    <link href="../../styles/vendor/kendo/web/kendo.common.min.css" rel="stylesheet">
    <link href="../../styles/vendor/kendo/web/kendo.default.min.css" rel="stylesheet">
    <link href="../../styles/vendor/kendo/web/kendo.default.mobile.min.css" rel="stylesheet">
    <!-- widgets.stage stylesheet -->
    <link href="../../styles/widgets/widgets.stage.css" rel="stylesheet">
    <!-- SystemJS loader -->
    <script src="../../../test/vendor/polyfill.min.js"></script>
    <script src="../../../test/vendor/system.js"></script>
    <script>
        (function () {
            'use strict';
            SystemJS.config({
                baseURL: '../../../',
                bundles: {
                    'kendogrid': ['kendo.grid'],
                    'kendoaspnetmvc': ['kendo.aspnetmvc'],
                    'kendodatavizbarcode': ['kendo.dataviz.barcode'],
                    'kendodatavizchart': ['kendo.dataviz.chart'],
                    'kendodatavizcore': ['kendo.dataviz.core'],
                    'kendodatavizdiagram': ['kendo.dataviz.diagram'],
                    'kendodatavizgauge': ['kendo.dataviz.gauge'],
                    'kendodatavizmap': ['kendo.dataviz.map'],
                    'kendodatavizqrcode': ['kendo.dataviz.qrcode'],
                    'kendodatavizsparkline': ['kendo.dataviz.sparkline'],
                    'kendodatavizstock': ['kendo.dataviz.stock'],
                    'kendodatavizthemes': ['kendo.dataviz.themes'],
                    'kendodataviztreemap': ['kendo.dataviz.treemap'],
                    'kendodrawing': ['kendo.drawing'],
                    'kendoeditor': ['kendo.editor'],
                    'kendogantt': ['kendo.gantt'],
                    'kendopdf': ['kendo.pdf'],
                    'kendoscheduler': ['kendo.scheduler'],
                    'kendospreadsheet': ['kendo.spreadsheet']
                },
                map: {
                    'jquery': 'src/js/vendor/jquery/jquery-3.3.1.js',
                    // http://docs.telerik.com/kendo-ui/third-party/systemjs
                    'kendo.culture.en-GB': 'src/js/vendor/kendo/cultures/kendo.culture.en-GB.js',
                    'kendo.messages.en-GB': 'src/js/vendor/kendo/messages/kendo.messages.en-GB.js',
                    'kendo.autocomplete': 'src/js/vendor/kendo/kendo.autocomplete.js',
                    'kendo.binder': 'src/js/vendor/kendo/kendo.binder.js',
                    'kendo.button': 'src/js/vendor/kendo/kendo.button.js',
                    'kendo.calendar': 'src/js/vendor/kendo/kendo.calendar.js',
                    'kendo.color': 'src/js/vendor/kendo/kendo.color.js',
                    'kendo.colorpicker': 'src/js/vendor/kendo/kendo.colorpicker.js',
                    'kendo.columnmenu': 'src/js/vendor/kendo/kendo.columnmenu.js',
                    'kendo.columnsorter': 'src/js/vendor/kendo/kendo.columnsorter.js',
                    'kendo.combobox': 'src/js/vendor/kendo/kendo.combobox.js',
                    'kendo.core': 'src/js/vendor/kendo/kendo.core.js',
                    'kendo.data': 'src/js/vendor/kendo/kendo.data.js',
                    'kendo.data.odata': 'src/js/vendor/kendo/kendo.data.odata.js',
                    'kendo.data.signalr': 'src/js/vendor/kendo/kendo.data.signalr.js',
                    'kendo.data.xml': 'src/js/vendor/kendo/kendo.data.xml.js',
                    'kendo.dateinput': 'src/js/vendor/kendo/kendo.dateinput.js',
                    'kendo.datepicker': 'src/js/vendor/kendo/kendo.datepicker.js',
                    'kendo.datetimepicker': 'src/js/vendor/kendo/kendo.datetimepicker.js',
                    'kendo.dialog': 'src/js/vendor/kendo/kendo.dialog.js',
                    'kendo.dom': 'src/js/vendor/kendo/kendo.dom.js',
                    'kendo.draganddrop': 'src/js/vendor/kendo/kendo.draganddrop.js',
                    'kendo.dropdownlist': 'src/js/vendor/kendo/kendo.dropdownlist.js',
                    'kendo.editable': 'src/js/vendor/kendo/kendo.editable.js',
                    'kendo.excel': 'src/js/vendor/kendo/kendo.excel.js',
                    'kendo.filebrowser': 'src/js/vendor/kendo/kendo.filebrowser.js',
                    'kendo.filtercell': 'src/js/vendor/kendo/kendo.filtercell.js',
                    'kendo.filtermenu': 'src/js/vendor/kendo/kendo.filtermenu.js',
                    'kendo.fx': 'src/js/vendor/kendo/kendo.fx.js',
                    'kendo.gantt.list': 'src/js/vendor/kendo/kendo.gantt.list.js',
                    'kendo.gantt.timeline': 'src/js/vendor/kendo/kendo.gantt.timeline.js',
                    'kendo.groupable': 'src/js/vendor/kendo/kendo.groupable.js',
                    'kendo.imagebrowser': 'src/js/vendor/kendo/kendo.imagebrowser.js',
                    'kendo.list': 'src/js/vendor/kendo/kendo.list.js',
                    'kendo.listview': 'src/js/vendor/kendo/kendo.listview.js',
                    'kendo.maskedtextbox': 'src/js/vendor/kendo/kendo.maskedtextbox.js',
                    'kendo.mediaplayer': 'src/js/vendor/kendo/kendo.mediaplayer.js',
                    'kendo.menu': 'src/js/vendor/kendo/kendo.menu.js',
                    'kendo.mobile.actionsheet': 'src/js/vendor/kendo/kendo.mobile.actionsheet.js',
                    'kendo.mobile.application': 'src/js/vendor/kendo/kendo.mobile.application.js',
                    'kendo.mobile.button': 'src/js/vendor/kendo/kendo.mobile.button.js',
                    'kendo.mobile.buttongroup': 'src/js/vendor/kendo/kendo.mobile.buttongroup.js',
                    'kendo.mobile.collapsible': 'src/js/vendor/kendo/kendo.mobile.collapsible.js',
                    'kendo.mobile.drawer': 'src/js/vendor/kendo/kendo.mobile.drawer.js',
                    'kendo.mobile.listview': 'src/js/vendor/kendo/kendo.mobile.listview.js',
                    'kendo.mobile.loader': 'src/js/vendor/kendo/kendo.mobile.loader.js',
                    'kendo.mobile.modalview': 'src/js/vendor/kendo/kendo.mobile.modalview.js',
                    'kendo.mobile.navbar': 'src/js/vendor/kendo/kendo.mobile.navbar.js',
                    'kendo.mobile.pane': 'src/js/vendor/kendo/kendo.mobile.pane.js',
                    'kendo.mobile.popover': 'src/js/vendor/kendo/kendo.mobile.popover.js',
                    'kendo.mobile.scroller': 'src/js/vendor/kendo/kendo.mobile.scroller.js',
                    'kendo.mobile.scrollview': 'src/js/vendor/kendo/kendo.mobile.scrollview.js',
                    'kendo.mobile.shim': 'src/js/vendor/kendo/kendo.mobile.shim.js',
                    'kendo.mobile.splitview': 'src/js/vendor/kendo/kendo.mobile.splitview.js',
                    'kendo.mobile.switch': 'src/js/vendor/kendo/kendo.mobile.switch.js',
                    'kendo.mobile.tabstrip': 'src/js/vendor/kendo/kendo.mobile.tabstrip.js',
                    'kendo.mobile.view': 'src/js/vendor/kendo/kendo.mobile.view.js',
                    'kendo.multicolumncombobox': 'src/js/vendor/kendo/kendo.multicolumncombobox.js',
                    'kendo.multiselect': 'src/js/vendor/kendo/kendo.multiselect.js',
                    'kendo.notification': 'src/js/vendor/kendo/kendo.notification.js',
                    'kendo.numerictextbox': 'src/js/vendor/kendo/kendo.numerictextbox.js',
                    'kendo.ooxml': 'src/js/vendor/kendo/kendo.ooxml.js',
                    'kendo.pager': 'src/js/vendor/kendo/kendo.pager.js',
                    'kendo.panelbar': 'src/js/vendor/kendo/kendo.panelbar.js',
                    'kendo.pivot.configurator': 'src/js/vendor/kendo/kendo.pivot.configurator.js',
                    'kendo.pivot.fieldmenu': 'src/js/vendor/kendo/kendo.pivot.fieldmenu.js',
                    'kendo.pivotgrid': 'src/js/vendor/kendo/kendo.pivotgrid.js',
                    'kendo.popup': 'src/js/vendor/kendo/kendo.popup.js',
                    'kendo.progressbar': 'src/js/vendor/kendo/kendo.progressbar.js',
                    'kendo.reorderable': 'src/js/vendor/kendo/kendo.reorderable.js',
                    'kendo.resizable': 'src/js/vendor/kendo/kendo.resizable.js',
                    'kendo.responsivepanel': 'src/js/vendor/kendo/kendo.responsivepanel.js',
                    'kendo.router': 'src/js/vendor/kendo/kendo.router.js',
                    'kendo.scheduler.agendaview': 'src/js/vendor/kendo/kendo.scheduler.agendaview.js',
                    'kendo.scheduler.dayview': 'src/js/vendor/kendo/kendo.scheduler.dayview.js',
                    'kendo.scheduler.monthview': 'src/js/vendor/kendo/kendo.scheduler.monthview.js',
                    'kendo.scheduler.recurrence': 'src/js/vendor/kendo/kendo.scheduler.recurrence.js',
                    'kendo.scheduler.timelineview': 'src/js/vendor/kendo/kendo.scheduler.timelineview.js',
                    'kendo.scheduler.view': 'src/js/vendor/kendo/kendo.scheduler.view.js',
                    'kendo.selectable': 'src/js/vendor/kendo/kendo.selectable.js',
                    'kendo.slider': 'src/js/vendor/kendo/kendo.slider.js',
                    'kendo.sortable': 'src/js/vendor/kendo/kendo.sortable.js',
                    'kendo.splitter': 'src/js/vendor/kendo/kendo.splitter.js',
                    'kendo.tabstrip': 'src/js/vendor/kendo/kendo.tabstrip.js',
                    'kendo.timepicker': 'src/js/vendor/kendo/kendo.timepicker.js',
                    'kendo.timezones': 'src/js/vendor/kendo/kendo.timezones.js',
                    'kendo.toolbar': 'src/js/vendor/kendo/kendo.toolbar.js',
                    'kendo.tooltip': 'src/js/vendor/kendo/kendo.tooltip.js',
                    'kendo.touch': 'src/js/vendor/kendo/kendo.touch.js',
                    'kendo.treelist': 'src/js/vendor/kendo/kendo.treelist.js',
                    'kendo.treeview.draganddrop': 'src/js/vendor/kendo/kendo.treeview.draganddrop.js',
                    'kendo.treeview': 'src/js/vendor/kendo/kendo.treeview.js',
                    'kendo.upload': 'src/js/vendor/kendo/kendo.upload.js',
                    'kendo.userevents': 'src/js/vendor/kendo/kendo.userevents.js',
                    'kendo.validator': 'src/js/vendor/kendo/kendo.validator.js',
                    'kendo.view': 'src/js/vendor/kendo/kendo.view.js',
                    'kendo.virtuallist': 'src/js/vendor/kendo/kendo.virtuallist.js',
                    'kendo.window': 'src/js/vendor/kendo/kendo.window.js',
                    'pako_deflate': 'src/js/vendor/kendo/pako_deflate.js',
                    'kendoaspnetmvc': 'src/js/vendor/kendo/kendo.aspnetmvc.js',
                    'kendodatavizbarcode': 'src/js/vendor/kendo/kendo.dataviz.barcode.js',
                    'kendodatavizchart': 'src/js/vendor/kendo/kendo.dataviz.chart.js',
                    'kendodatavizcore': 'src/js/vendor/kendo/kendo.dataviz.core.js',
                    'kendodatavizdiagram': 'src/js/vendor/kendo/kendo.dataviz.diagram.js',
                    'kendodatavizgauge': 'src/js/vendor/kendo/kendo.dataviz.gauge.js',
                    'kendodatavizmap': 'src/js/vendor/kendo/kendo.dataviz.map.js',
                    'kendodatavizqrcode': 'src/js/vendor/kendo/kendo.dataviz.qrcode.js',
                    'kendodatavizsparkline': 'src/js/vendor/kendo/kendo.dataviz.sparkline.js',
                    'kendodatavizstock': 'src/js/vendor/kendo/kendo.dataviz.stock.js',
                    'kendodatavizthemes': 'src/js/vendor/kendo/kendo.dataviz.themes.js',
                    'kendodataviztreemap': 'src/js/vendor/kendo/kendo.dataviz.treemap.js',
                    'kendodrawing': 'src/js/vendor/kendo/kendo.drawing.js',
                    'kendoeditor': 'src/js/vendor/kendo/kendo.editor.js',
                    'kendogantt': 'src/js/vendor/kendo/kendo.gantt.js',
                    'kendogrid': 'src/js/vendor/kendo/kendo.grid.js',
                    'kendopdf': 'src/js/vendor/kendo/kendo.pdf.js',
                    'kendoscheduler': 'src/js/vendor/kendo/kendo.scheduler.js',
                    'kendospreadsheet': 'src/js/vendor/kendo/kendo.spreadsheet.js'
                },
                packages: {
                    'src/js': {
                        defaultExtension: 'js',
                        meta: {
                            // IMPORTANT! See https://github.com/jshint/jshint/issues/2840
                            'vendor/codemirror/addon/lint/jshint.js': {
                                format: 'global'
                            },
                            'vendor/modernizr/modernizr.js': {
                                format: 'global'
                            },
                            '*.js': {
                                babelOptions: {
                                    es2015: false,
                                    stage2: false,
                                    stage3: false
                                },
                                format: 'amd'
                            },
                            '*.es6': {
                                format: 'esm'
                            }
                        }
                    }
                },
                paths: {
                    'plugin-babel': 'node_modules/systemjs-plugin-babel/plugin-babel.js',
                    'systemjs-babel-build': 'node_modules/systemjs-plugin-babel/systemjs-babel-browser.js'
                },
                transpiler: 'plugin-babel'
            });
            Promise.all([
                SystemJS.import('kendo.binder'),
                SystemJS.import('kendo.slider'),
                SystemJS.import('../loader.grid.es6'),
                SystemJS.import('../data/models.pagecomponent.es6'),
                SystemJS.import('../data/datasources.pagecomponent.es6'),
                SystemJS.import('../tools/tools.es6'),
                SystemJS.import('../tools/tools.base.es6'),
                SystemJS.import('../app/app.tools.es6'),
                SystemJS.import('./widgets.toolbox.es6'),
                SystemJS.import('./widgets.stage.es6')
            ]).then(function (modules) {
                var kendo = window.kendo;
                var PageComponent = modules[3].default;
                var PageComponentDataSource = modules[4].default;
                var tools = modules[5].default;
                var BaseTool = modules[6].default;

                /**
                 * New square tool for testing
                 */
                var Square = BaseTool.extend({
                    id: 'square',
                    icon: 'shapes',
                    name: 'Square',
                    description: 'Square',
                    cursor: 'progress',
                    templates: {
                        play: '<div style="background-color:#00FF00;">PLAY</div>',
                        design: '<div style="background-color:#0000FF;">DESIGN</div>',
                        review: '<div style="background-color:#FF0000;">REVIEW</div>'
                    },
                    height: 300,
                    width: 300,
                    attributes: {
                        // src: new adapters.AssetAdapter({ title: 'Image', defaultValue: 'cdn://images/o_collection/svg/office/painting_landscape.svg' }),
                        // alt: new adapters.StringAdapter({ title: 'Text', defaultValue: 'Painting Landscape' })
                    },

                    getHtmlContent: function (component, mode) {
                        assert.instanceof(Square, this, assert.format(assert.messages.instanceof.default, 'this', 'Square'));
                        assert.instanceof(PageComponent, component, assert.format(assert.messages.instanceof.default, 'component', 'PageComponent'));
                        var modes = kendo.ui.Stage.fn.modes;
                        assert.enum(Object.values(modes), mode, assert.format(assert.messages.enum.default, 'mode', Object.values(modes)));
                        return $(this.templates[mode]);
                    },

                    onEnable: function(e, component, enabled) {
                        var stageElement = $(e.currentTarget);
                        if (stageElement.is('.kj-element')) {
                            var content = stageElement.children('div');
                            assert.ok(content.length === 1, 'Square elements are expected to be constituted of a single div');
                            content.off('click');
                            if (enabled) {
                                content.on('click', function () {
                                    window.alert('Hello from ' + component.uid);
                                });
                            }
                        }
                    },

                    onResize: function (e, component) {
                        var stageElement = $(e.currentTarget);
                        if (stageElement.is('.kj-element') && component instanceof PageComponent) {
                            var content = stageElement.children('div');
                            if ($.type(component.width) === 'number') {
                                content.width(component.width);
                            }
                            if ($.type(component.height) === 'number') {
                                content.height(component.height);
                            }
                            // prevent any side effect
                            e.preventDefault();
                            // prevent event to bubble on stage
                            e.stopPropagation();
                        }
                    }

                });
                tools.register(Square);

                /**
                 * Stage content
                 */
                var data = [
                    { id: kendo.guid(), tool : 'image', top: 50, left: 100, height: 250, width: 250, rotate: 45, attributes: { src: 'http://marketingland.com/wp-content/ml-loads/2013/04/google-g-logo-2012.png' } },
                    { id: kendo.guid(), tool : 'image', top: 300, left: 300, height: 250, width: 250, rotate: 315, attributes: { src: 'http://4.bp.blogspot.com/_cPxcXn8pqkM/TCoCrLc7mVI/AAAAAAAABF0/8d6paccQU8A/s320/228_facebook.jpg' } },
                    { id: kendo.guid(), tool : 'square', top: 500, left: 100, height: 200, width: 200, rotate: 25, attributes: {} },
                    { id: kendo.guid(), tool : 'label', top: 250, left: 500, height: 100, width: 300, rotate: 90, attributes: { style: 'font-family: Georgia, serif; color: #FF0000; font-size: 80px;', text: 'World' } },
                    { id: kendo.guid(), tool : 'textbox', top: 20, left: 20, height: 100, width: 300, rotate: 0, attributes: {}, properties: { name: 'textfield3' } }
                ];
                var viewModel = kendo.observable({
                    components: new PageComponentDataSource({ data }),
                    component: null,
                    onSliderChange(e) {
                        var stage = $('#stage').data('kendoStage');
                        stage.scale(e.value/100);
                    },
                    onInputModeChange(e) {
                        var stage = $('#stage').data('kendoStage');
                        var m = e.currentTarget.value;
                        window.location.hash = m;
                        stage.mode(m);
                    },
                    onEnabledChange(e) {
                        var stage = $('#stage').data('kendoStage');
                        switch(e.currentTarget.id) {
                            case "enabled":
                                stage.enable(e.currentTarget.checked);
                                break;
                            case "readonly":
                                stage.readonly(e.currentTarget.checked);
                                break;
                        }
                    },
                    onGridSelect(e) {
                        var stage = $('#stage').data('kendoStage');
                        var rows = this.select();
                        var component = this.dataItem(rows[0]);
                        if(component) {
                            stage.value(component);
                        }
                    },
                    onStageSelect(e) {
                        var grid = $('#grid').data('kendoGrid');
                        if(e.value) {
                            var uid = grid.dataSource.get(e.value.id).uid;
                            var rows = grid.table.find('tr[data-uid="' + uid + '"]');
                            if (!rows.hasClass('k-state-selected')) {
                                grid.select(rows);
                            }
                        } else {
                            grid.clearSelection();
                        }
                    }
                });

                /**
                 * Initialization
                 */
                $(function() {
                    var mode = window.location.hash.substr(1);
                    mode = mode.length ? mode : 'design';

                    // Prepare slider for binding
                    $('#slider')
                        .attr(kendo.attr('role'), 'slider')
                        .attr(kendo.attr('decreaseButtonTitle'), 'Zoom out')
                        .attr(kendo.attr('increaseButtonTitle'), 'Zoom in')
                        .attr(kendo.attr('largeStep'), 10)
                        .attr(kendo.attr('min'), 0)
                        .attr(kendo.attr('max'), 100)
                        .attr(kendo.attr('smallStep'), 1);

                    $('input#' + mode).prop('checked', true);

                    $('input[type="radio"][name="mode"]')
                        .attr(kendo.attr('bind'), 'events: { change: onInputModeChange }');

                    $('input[type="checkbox"]')
                        .attr(kendo.attr('bind'), 'events: { change: onEnabledChange }');

                    // Prepare toolbox
                    $('#toolbox')
                        .attr(kendo.attr('role'), 'toolbox');

                    // Prepare stage for binding
                    // TODO $('#stage, #stage2')
                    $('#stage')
                        .attr(kendo.attr('role'), 'stage')
                        .attr(kendo.attr('autoBind'), false)
                        .attr(kendo.attr('bind'), 'source: components, value: component')
                        .attr(kendo.attr('mode'), mode);

                    // Prepare grid for binding
                    $('#grid')
                        .attr(kendo.attr('role'), 'grid')
                        .attr(kendo.attr('autoBind'), false)
                        .attr(kendo.attr('bind'), 'source: components')
                        .attr(kendo.attr('editable'), true)
                        .attr(kendo.attr('height'), 300)
                        .attr(kendo.attr('selectable'), true)
                        .attr(kendo.attr('columns'), JSON.stringify([
                            {
                                field: "id",
                                title: "Id",
                                width: 320
                            },
                            {
                                field: "tool",
                                title: "Tool",
                                width: 100
                            },
                            {
                                field: "top",
                                title: "Top",
                                width: 60
                            },
                            {
                                field: "left",
                                title: "Left",
                                width: 60
                            },
                            {
                                field: "height",
                                title: "Hei.",
                                width: 60
                            },
                            {
                                field: "width",
                                title: "Wid.",
                                width: 60
                            },
                            {
                                field: "rotate",
                                title: "Rot.",
                                width: 60
                            },
                            /*
                            {
                                field: "attributes",
                                title: "Attributes"
                            },
                            {
                                field: "properties",
                                title: "Properties"
                            },
                            */
                            {
                                command: "destroy",
                                title: "&nbsp;",
                                width: 120
                            }
                        ]))
                        .attr(kendo.attr('height'), 300);

                    // Bind html and events
                    kendo.bind('body', viewModel);
                    $('#slider').data('kendoSlider').bind('change', viewModel.onSliderChange);
                    $('#stage').data('kendoStage').bind('select', viewModel.onStageSelect);
                    $('#grid').data('kendoGrid').bind('change', viewModel.onGridSelect);

                    //Note: we have autoBind = false, so we need to read manually
                    viewModel.components.read();

                });
            });
        }());
    </script>
    <style>
        body { background-color: darkgrey; }
    </style>
</head>
<body>
<h1>widgets.stage</h1>
<div>
    <input id="slider" value="100" />
    <input id="design" type="radio" name="mode" value="design" checked=true /><label for="design">design</label>
    <input id="play" type="radio" name="mode" value="play" /><label for="play">play</label>
    <input id="review" type="radio" name="mode" value="review" /><label for="review">review</label>
    <input id="enabled" type="checkbox" checked /><label for="enabled">enabled</label>
    <input id="readonly" type="checkbox" /><label for="readonly">readonly</label>
</div>
<div id="toolbox"></div>
<div id="stage"></div>
<div id="grid"></div>
<div id="stage2" data-scale="0.25"></div>
</body>
</html>
