<!DOCTYPE html>
<html>
<head>
    <title>kidoju.integration.playmode</title>
    <!--link href="//cdn.kendostatic.com/2015.1.318/styles/kendo.common.min.css" rel="stylesheet">
    <link href="//cdn.kendostatic.com/2015.1.318/styles/kendo.default.min.css" rel="stylesheet"-->
    <link href="./styles/vendor/kendo.common.min.css" rel="stylesheet">
    <link href="./styles/vendor/kendo.default.min.css" rel="stylesheet">
    <!--script src="//code.jquery.com/jquery-1.9.1.min.js"></script-->
    <script src="./js/vendor/jquery.min.js"></script>
    <!--script src="//cdn.kendostatic.com/2015.1.318/js/kendo.all.min.js"></script-->
    <script src="./js/vendor/kendo.all.min.js"></script>
    <!--script src="../temp/2015.1.318/src/src/kendo.core.js"></script>
    <script src="../temp/2015.1.318/src/src/kendo.data.js"></script>
    <script src="../temp/2015.1.318/src/src/kendo.binder.js"></script-->
    <!-- Play mode requirements -->
    <!--link rel="stylesheet" href="./styles/kidoju.widgets.playbar.css"-->
    <link rel="stylesheet" href="./styles/kidoju.widgets.stage.css">
    <script src="js/kidoju.data.js"></script>
    <script src="./js/kidoju.tools.js"></script>
    <script src="./js/kidoju.widgets.bindings.js"></script>
    <script src="./js/kidoju.widgets.playbar.js"></script>
    <script src="./js/kidoju.widgets.stage.js"></script>
    <style>
        html, body {
            font: 14px sans-serif;
            margin: 0;
            width: 100%;
            height: 100%;
        }
        header {
            height: 48px;
            background-color: #001111;
        }
        header>img {
            padding: 2px 5px;
        }
        footer {
            position: absolute;
            height: 35px;
            bottom: 0px;
        }
        footer>div {
            padding: 8px;
        }
    </style>
</head>
<body>
<header>
    <img src="https://raw.githubusercontent.com/Memba/Kidoju-Webapp/master/webapp/public/styles/images/KdjLogoBB.png" alt="Kidoju Logo">
</header>
<main>
    <div data-role="playbar" data-bind="source: stream.pages, value: currentPage, events: {click: calculate}"></div>
    <div data-role="stage" data-bind="source: currentPage.components, properties: test" data-mode="play"></div>
    <div>
        <label>textfield1:</label><input data-bind="value: test.textfield1"><br/>
        <label>textfield2:</label><input data-bind="value: test.textfield2"><br/>
        <label>textfield3:</label><input data-bind="value: test.textfield3"><br/>
    </div>
</main>
<footer>
    <div>Copyright &copy; 2013-2015 Memba Sarl. All rights reserved.</div>
</footer>
<script>

    //LocalStream with localStorage methods
    var storageKey = 'kidoju.integration',
        LocalStream = kidoju.Stream.define({
            load: function() {
                var that = this,
                    dfd = $.Deferred(),
                    stream = localStorage.getItem(storageKey),
                    pages = [];
                if($.type(stream) === 'string') {
                    try {
                        stream = $.parseJSON(stream);
                    } catch(e) {
                        stream = {};
                    }
                }
                if($.isArray(stream.pages)) {
                    pages = stream.pages.slice();
                }
                stream.pages = undefined;
                that.accept(stream);
                that.pages = new kidoju.PageCollectionDataSource({data: pages});
                that.pages.fetch()
                    .done(function() {
                        var promises = [];
                        $.each(that.pages.data(), function(index, page) {
                            promises.push(page.components.fetch());
                        });
                        $.when.apply($, promises)
                            .done(dfd.resolve)
                            .fail(dfd.reject);
                    })
                    .fail(dfd.reject);
                return dfd.promise();
            },
            save: function() {
                //TODO: check changes and avoid saving without changes
                var that = this,
                    dfd = $.Deferred();
                if (that.isNew()) {
                    that.accept({id: kendo.guid()});
                }
                var data = $.extend(that.toJSON(), { pages : [] });
                $.each(that.pages.data(), function(pageIdx, page){
                    if (page.isNew()) {
                        page.accept({id: kendo.guid()});
                    }
                    if (page.dirty) {
                        page.dirty = false;
                    }
                    data.pages.push($.extend(page.toJSON(), { components: [] }));
                    $.each(page.components.data(), function(componentIdx, component) {
                        if (component.isNew()) {
                            component.accept({id: kendo.guid()});
                        }
                        if (component.dirty) {
                            component.dirty = false;
                        }
                        data.pages[data.pages.length - 1].components.push(component.toJSON());
                    });
                });
                localStorage.setItem(storageKey, kendo.stringify(data));
                return dfd.resolve().promise();
            }
        }),
        streamData = {
            id: kendo.guid(),
            pages: [
                {
                    id: kendo.guid(),
                    components: [
                        { id: kendo.guid(), tool : 'image', top: 50, left: 370, height: 250, width: 250, rotate: 0, attributes: { src: 'http://marketingland.com/wp-content/ml-loads/2013/04/google-g-logo-2012.png' } },
                        { id: kendo.guid(), tool : 'label', top: 300, left: 300, height: 100, width: 300, rotate: 0, attributes: { style: 'font-family: Georgia, serif; color: #0000FF;', text: 'Company?' } },
                        { id: kendo.guid(), tool : 'textbox', top: 450, left: 350, height: 100, width: 300, rotate: 0, attributes: {}, properties: { name: 'textfield1' } }
                    ]
                },
                {
                    id: kendo.guid(),
                    components: [
                        { id: kendo.guid(), tool : 'label', top: 150, left: 280, height: 100, width: 300, rotate: 0, attributes: { style: 'font-family: Georgia, serif; color: #FF0000;', text: 'Marignan?' } },
                        { id: kendo.guid(), tool : 'textbox', top: 300, left: 330, height: 100, width: 300, rotate: 0, attributes: {}, properties: { name: 'textfield2' } }
                    ]
                },
                {
                    id: kendo.guid(),
                    components: [
                        { id: kendo.guid(), tool : 'label', top: 120, left: 280, height: 150, width: 400, rotate: 0, attributes: { style: 'font-family: Georgia, serif; color: #00FF00;', text: 'Couleur du cheval blanc d\'Henri IV?' } },
                        { id: kendo.guid(), tool : 'textbox', top: 300, left: 330, height: 100, width: 300, rotate: 0, attributes: {}, properties: { name: 'textfield3' } }
                    ]
                }
            ]
        };

    //Create some dummy data
    if (!window.localStorage.getItem(storageKey)) {
        window.localStorage.setItem(storageKey, kendo.stringify(streamData));
    }

    //Define viewModel
    var viewModel = window.viewModel = kendo.observable({
        stream: new LocalStream(),
        currentPage: undefined,
        test: undefined,
        result: undefined,
        calculate: function() {
            window.viewModel.set('result', viewModel.stream.pages.validateTestFromProperties(window.viewModel.get('test')));
        }
    });

    $(document).ready(function() {
        viewModel.stream.load().then(function() {
            window.viewModel.set('currentPage', viewModel.stream.pages.at(0));
            window.viewModel.set('test', viewModel.stream.pages.getTestFromProperties());
            kendo.bind('body', viewModel);
        });
    });

</script>
</body>
</html>
